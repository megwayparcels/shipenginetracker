const axios = require("axios");

module.exports = async (req, res) => {
  // Allow HubSpot site
  res.setHeader("Access-Control-Allow-Origin", "https://northampton.megwayparcels.co.uk");
  res.setHeader("Access-Control-Allow-Methods", "POST, OPTIONS");
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");

  // Handle preflight
  if (req.method === "OPTIONS") {
    return res.status(204).end();
  }

  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const { tracking_number, carrier_code } = req.body || {};
    if (!tracking_number) {
      return res.status(400).json({ error: "tracking_number is required" });
    }

    const params = { tracking_number };
    if (carrier_code) params.carrier_code = carrier_code;

    const shipResp = await axios.get("https://api.shipengine.com/v1/tracking", {
      params,
      headers: {
        "API-Key": process.env.SHIPENGINE_API_KEY,
        "Content-Type": "application/json",
      },
    });

    return res.status(200).json(shipResp.data);
  } catch (err) {
    console.error("ShipEngine error:", err.response?.data || err.message);
    const status = err.response?.status || 500;
    const payload = err.response?.data || { error: err.message || "Unknown error" };
    return res.status(status).json(payload);
  }
};
